<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: sans-serif; margin: 20px; background-color: #f9f9f9; color: #333; }
    h1 { font-size: 1.5em; color: #444; border-bottom: 2px solid #007bff; padding-bottom: 10px; }
    .card { background: #fff; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 20px; padding: 20px; }
    
    .form-group { margin-bottom: 10px; }
    .form-group label { font-weight: bold; display: block; margin-bottom: 3px; font-size: 0.9em; color: #666; }
    .form-group input, .form-group select { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; font-size: 1em; }
    .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
    .shipment-options { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-top: 15px; }
    
    .item-list { list-style: none; padding: 0; }
    .item { border-bottom: 1px solid #eee; padding: 15px 5px; }
    .item-header { display: flex; align-items: center; font-weight: bold; }
    .item-header input { margin-right: 15px; transform: scale(1.5); }
    .item-details { font-size: 0.9em; color: #666; margin-top: 5px; padding-left: 35px; }
    .item-details span { margin-right: 15px; }
    .ship-input { margin-top: 10px; padding-left: 35px; }
    .ship-input input { width: 100px; padding: 5px; }
    .input-error { border: 2px solid red !important; background-color: #ffe6e6; }

    .button { background-color: #007bff; color: white; padding: 12px; border: none; border-radius: 5px; cursor: pointer; width: 100%; font-size: 1.1em; margin-top: 10px; }
    .button:disabled { background-color: #aaa; }
    .button-secondary { background-color: #6c757d; }
    .button-info { background-color: #17a2b8; margin-bottom: 15px; }

    #modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 100; }
    #modal-content { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #fff; padding: 20px; width: 90%; max-width: 600px; max-height: 80%; overflow-y: auto; border-radius: 8px; }
    .history-item { border: 1px solid #ddd; padding: 10px; margin-bottom: 10px; border-radius: 4px; cursor: pointer; transition: background 0.2s; }
    .history-item:hover { background-color: #f0f8ff; }
    
    #loader { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); z-index: 999; text-align: center; padding-top: 40vh; font-size: 1.2em; }
    #message-area { display: none; padding: 15px; border-radius: 5px; margin-top: 20px; }
    .success { background-color: #d4edda; color: #155724; }
    .error { background-color: #f8d7da; color: #721c24; }
  </style>
</head>
<body>

  <div id="main-content">
    <div class="card">
      <h1><span id="title-juchu-no"></span> ã®å‡ºè·å‡¦ç†</h1>
      <button class="button button-info" onclick="showHistory()">ğŸ“œ ä½œæˆæ¸ˆã¿ã®å‡ºè·æ˜ç´°æ›¸ã‚’ç¢ºèªãƒ»ä¿®æ­£ã™ã‚‹</button>

      <div class="grid-2">
        <div class="form-group"><label>å¾—æ„å…ˆã‚³ãƒ¼ãƒ‰</label><input type="text" id="tokuisaki-code"></div>
        <div class="form-group"><label>å¾—æ„å…ˆå</label><input type="text" id="tokuisaki-name"></div>
      </div>
      <div class="form-group"><label>å…ˆæ–¹æ‹…å½“è€…å</label><input type="text" id="senpo-tantosha"></div>
      <div class="grid-2">
        <div class="form-group"><label>ç›´é€å…ˆå</label><input type="text" id="chokusosaki-name"></div>
        <div class="form-group"><label>ç›´é€å…ˆåï¼’</label><input type="text" id="chokusosaki-name2"></div>
      </div>
      <div class="form-group"><label>ç›´é€å…ˆæ‹…å½“è€…å</label><input type="text" id="chokusosaki-tantosha"></div>
      
      <div class="grid-3">
        <div class="form-group"><label>éƒµä¾¿ç•ªå·</label><input type="text" id="postal-code"></div>
        <div class="form-group"><label>ä½æ‰€ï¼‘</label><input type="text" id="address1"></div>
        <div class="form-group"><label>ä½æ‰€ï¼’</label><input type="text" id="address2"></div>
      </div>
      <div class="form-group"><label>ä¼šç¤¾TEL</label><input type="text" id="kaisha-tel"></div>

      <div class="grid-2">
        <div class="form-group"><label>FMæƒ…å ±No</label><input type="text" id="fm-info-no"></div>
        <div class="form-group"><label>FMå‡ºè·No</label><input type="text" id="fm-shukka-no"></div>
      </div>

      <div class="shipment-options">
        <div><label>å‡ºè·æ—¥</label><input type="date" id="shipping-date"></div>
        <div><label>åˆ°ç€æ—¥</label><input type="date" id="arrival-date"></div>
        <div><label>åˆ°ç€æ™‚åˆ»</label>
          <select id="arrival-time">
            <option>åˆå‰ä¸­</option><option>14æ™‚ï½16æ™‚</option><option>16æ™‚ï½18æ™‚</option><option>18æ™‚ä»¥é™</option><option>æŒ‡å®šãªã—</option>
          </select>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="select-all" style="padding:10px; background:#f0f0f0; margin-bottom:10px;">
        <input type="checkbox" id="check-all" onchange="toggleAll(this)">
        <label for="check-all">å…¨é¸æŠ</label>
      </div>
      <ul id="item-list-container" class="item-list"></ul>
    </div>
    
    <button id="submit-button" class="button" onclick="handleSubmit()">å‡ºè·ä¼ç¥¨ã‚’ä½œæˆã™ã‚‹</button>
    <div id="edit-mode-notice" style="display:none; text-align:center; color:red; margin-top:10px; font-weight:bold;">â€»ä¿®æ­£ãƒ¢ãƒ¼ãƒ‰ï¼ˆVer2ä½œæˆï¼‰ã§ã™</div>
  </div>
  
  <div id="message-area"></div>
  <div id="loader"><p>å—æ³¨ä¼ç¥¨ã‚’èª­ã¿è¾¼ã¿ä¸­ã§ã™...</p></div>

  <div id="modal-overlay" onclick="closeModal()">
    <div id="modal-content" onclick="event.stopPropagation()">
      <h2>ä½œæˆæ¸ˆã¿å‡ºè·æ˜ç´°æ›¸ä¸€è¦§</h2>
      <div id="history-list">èª­ã¿è¾¼ã¿ä¸­...</div>
      <button class="button button-secondary" onclick="closeModal()" style="margin-top:20px;">é–‰ã˜ã‚‹</button>
    </div>
  </div>

  <script>
    let currentJuchuNo = "<?= juchuNo ?>";
    let gData = {};
    let editingSlipId = null;
    let currentTokuisakiName2 = ''; 

    window.onload = function() {
      setTodayToDateInput('shipping-date');
      setTodayToDateInput('arrival-date');
      runDataFetch();
    };

    function setTodayToDateInput(id) {
      const d = new Date();
      d.setMinutes(d.getMinutes() - d.getTimezoneOffset());
      document.getElementById(id).value = d.toISOString().split('T')[0];
    }

    function runDataFetch() {
      document.getElementById('loader').innerHTML = '<p>å—æ³¨ä¼ç¥¨ã‚’èª­ã¿è¾¼ã¿ä¸­ã§ã™ã€‚<br>ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„ã€‚</p>';
      showLoader(true);
      document.getElementById('message-area').style.display = 'none';
      document.getElementById('main-content').style.display = 'block';
      document.getElementById('submit-button').innerText = 'å‡ºè·ä¼ç¥¨ã‚’ä½œæˆã™ã‚‹';
      document.getElementById('submit-button').disabled = false;
      document.getElementById('edit-mode-notice').style.display = 'none';
      
      editingSlipId = null;
      setTodayToDateInput('shipping-date');
      setTodayToDateInput('arrival-date');

      google.script.run
        .withSuccessHandler(initData)
        .withFailureHandler(showError)
        .getSalesOrderData(currentJuchuNo);
    }

    function initData(data) {
      showLoader(false);
      if(data.status === 'error') { showError(data.message); return; }
      gData = data;
      
      currentTokuisakiName2 = data.tokuisakiName2;

      document.getElementById('title-juchu-no').innerText = data.juchuNo;
      setFormValues({
        tokuisakiCode: data.tokuisakiCode,
        tokuisakiName: data.tokuisakiName,
        senpoTantoshaName: data.senpoTantoshaName,
        chokusosakiName: data.chokusosakiName,
        chokusosakiName2: data.chokusosakiName2,
        chokusosakiTantoshaName: data.chokusosakiTantoshaName, // â˜…è¿½åŠ 
        postalCode: data.postalCode,
        address1: data.address1,
        address2: data.address2,
        kaishaTel: data.kaishaTel,
        fmInfoNo: data.fmInfoNo,
        fmShukkaNo: data.fmShukkaNo
      });
      
      renderItemList(data.meisaiList);
    }

    function setFormValues(vals) {
      document.getElementById('tokuisaki-code').value = vals.tokuisakiCode;
      document.getElementById('tokuisaki-name').value = vals.tokuisakiName;
      document.getElementById('senpo-tantosha').value = vals.senpoTantoshaName;
      document.getElementById('chokusosaki-name').value = vals.chokusosakiName;
      document.getElementById('chokusosaki-name2').value = vals.chokusosakiName2;
      document.getElementById('chokusosaki-tantosha').value = vals.chokusosakiTantoshaName; // â˜…è¿½åŠ 
      document.getElementById('postal-code').value = vals.postalCode;
      document.getElementById('address1').value = vals.address1;
      document.getElementById('address2').value = vals.address2;
      document.getElementById('kaisha-tel').value = vals.kaishaTel;
      document.getElementById('fm-info-no').value = vals.fmInfoNo;
      document.getElementById('fm-shukka-no').value = vals.fmShukkaNo;
    }

    function renderItemList(list, prevQuantities = {}) {
      const container = document.getElementById('item-list-container');
      container.innerHTML = '';
      document.getElementById('check-all').checked = false;

      list.forEach(item => {
        const li = document.createElement('li');
        li.className = 'item';
        
        const prevQty = prevQuantities[String(item.meisaiNo)] || 0;
        const kano = Number(item.shukkaKanoSuryo);
        const limit = kano + Number(prevQty);

        li.dataset.meisaiNo = item.meisaiNo;
        li.dataset.rowNum = item.rowNum;
        li.dataset.shohinCode = item.shohinCode;
        li.dataset.shohinName = item.shohinName;
        li.dataset.kanoSuryo = kano; 
        li.dataset.prevQty = prevQty;
        li.dataset.limit = limit;

        const isChecked = prevQty > 0;
        const inputVal = isChecked ? prevQty : limit;

        li.innerHTML = `
          <div class="item-header">
            <input type="checkbox" class="item-check" onchange="toggleInput(this)" ${isChecked ? 'checked' : ''}>
            <strong>${item.shohinName}</strong>
          </div>
          <div class="item-details">
            <span>å—æ³¨: ${item.juchuSuryo}</span>
            <span>æ¸ˆ: ${item.shukkaZumiSuryo}</span>
            <span><strong>æ®‹: ${kano}</strong></span>
            ${prevQty > 0 ? `<span style="color:blue;">(å‰å›: ${prevQty})</span>` : ''}
          </div>
          <div class="ship-input">
            <label>ä»Šå›æ•° (Max:${limit}):</label>
            <input type="number" class="item-quantity" 
              value="${isChecked ? inputVal : ''}" 
              max="${limit}" min="0"
              ${isChecked ? '' : 'disabled'}>
          </div>
        `;
        container.appendChild(li);
      });
    }

    function showHistory() {
      document.getElementById('modal-overlay').style.display = 'block';
      document.getElementById('history-list').innerHTML = 'èª­ã¿è¾¼ã¿ä¸­...';
      google.script.run.withSuccessHandler(renderHistory).getShipmentHistoryList(currentJuchuNo);
    }
    function closeModal() { document.getElementById('modal-overlay').style.display = 'none'; }
    
    function renderHistory(res) {
      const listDiv = document.getElementById('history-list');
      listDiv.innerHTML = '';
      if(!res.historyList || res.historyList.length === 0) {
        listDiv.innerHTML = '<p>å±¥æ­´ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
        return;
      }
      res.historyList.forEach(h => {
        const div = document.createElement('div');
        div.className = 'history-item';
        div.innerHTML = `
          <strong>${h.timestampStr}</strong> ä½œæˆ<br>
          å‡ºè·: ${h.shippingDate} <a href="${h.fileUrl}" target="_blank" onclick="event.stopPropagation()">[ãƒ•ã‚¡ã‚¤ãƒ«]</a>
        `;
        div.onclick = () => loadHistory(h);
        listDiv.appendChild(div);
      });
    }

    function loadHistory(hist) {
      if(!confirm('ã“ã®ä¼ç¥¨ã‚’ä¿®æ­£ã—ã¾ã™ã‹ï¼Ÿ\n(ç¾åœ¨ã®å…¥åŠ›ã¯ç ´æ£„ã•ã‚Œã¾ã™)')) return;
      closeModal();
      showLoader(true, 'ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒä¸­...');
      
      editingSlipId = hist.slipId;
      setFormValues(hist);
      document.getElementById('shipping-date').value = hist.shippingDate;
      document.getElementById('arrival-date').value = hist.arrivalDate;
      document.getElementById('arrival-time').value = hist.arrivalTime;
      
      google.script.run.withSuccessHandler(res => {
        showLoader(false);
        renderItemList(gData.meisaiList, res.details);
        document.getElementById('submit-button').innerText = 'ä¿®æ­£ã—ã¦ Ver2 ã‚’ä½œæˆã™ã‚‹';
        document.getElementById('edit-mode-notice').style.display = 'block';
      }).getHistoryDetails(hist.slipId);
    }

    function toggleInput(checkbox) {
      const li = checkbox.closest('.item');
      const input = li.querySelector('.item-quantity');
      const limit = li.dataset.limit;
      
      if (checkbox.checked) {
        input.disabled = false;
        input.value = limit;
        input.focus();
      } else {
        input.disabled = true;
        input.value = '';
        input.classList.remove('input-error');
      }
    }
    function toggleAll(main) {
      document.querySelectorAll('.item-check').forEach(c => { c.checked = main.checked; toggleInput(c); });
    }
    
    function handleSubmit() {
      const checks = document.querySelectorAll('.item-check:checked');
      if(checks.length === 0) { alert('å•†å“ã‚’é¸æŠã—ã¦ãã ã•ã„'); return; }
      
      const items = [];
      let hasError = false;
      checks.forEach(c => {
        const li = c.closest('.item');
        const input = li.querySelector('.item-quantity');
        const val = parseInt(input.value);
        const limit = parseInt(li.dataset.limit);
        
        input.classList.remove('input-error');
        if(isNaN(val) || val <= 0) { alert('æ•°é‡ä¸æ­£'); input.classList.add('input-error'); hasError=true; return; }
        if(val > limit) { alert('æ•°é‡ã‚ªãƒ¼ãƒãƒ¼'); input.classList.add('input-error'); hasError=true; return; }
        
        items.push({
          meisaiNo: li.dataset.meisaiNo,
          rowNum: li.dataset.rowNum,
          shohinCode: li.dataset.shohinCode,
          shohinName: li.dataset.shohinName,
          shukkaSu: val,
          prevQty: li.dataset.prevQty || 0
        });
      });
      if(hasError) return;
      
      if(!confirm('å‡ºè·ä¼ç¥¨ã‚’ä½œæˆã—ã¾ã™ã‹ï¼Ÿ')) return;
      
      const sendData = {
        juchuNo: currentJuchuNo,
        originalSlipId: editingSlipId,
        
        tokuisakiCode: document.getElementById('tokuisaki-code').value,
        tokuisakiName: document.getElementById('tokuisaki-name').value,
        tokuisakiName2: currentTokuisakiName2, 
        senpoTantoshaName: document.getElementById('senpo-tantosha').value,
        chokusosakiName: document.getElementById('chokusosaki-name').value,
        chokusosakiName2: document.getElementById('chokusosaki-name2').value,
        chokusosakiTantoshaName: document.getElementById('chokusosaki-tantosha').value, // â˜…è¿½åŠ 
        postalCode: document.getElementById('postal-code').value,
        address1: document.getElementById('address1').value,
        address2: document.getElementById('address2').value,
        kaishaTel: document.getElementById('kaisha-tel').value,
        fmInfoNo: document.getElementById('fm-info-no').value, 
        fmShukkaNo: document.getElementById('fm-shukka-no').value, 
        
        shippingDate: document.getElementById('shipping-date').value,
        arrivalDate: document.getElementById('arrival-date').value,
        arrivalTime: document.getElementById('arrival-time').value,
        
        tantoshaName: gData.tantoshaName,
        items: items
      };
      
      document.getElementById('loader').innerHTML = '<p>å‡¦ç†ä¸­ã§ã™...<br>å‡ºè·ä¼ç¥¨ã‚’ä½œæˆã—ã¦ã„ã¾ã™ã€‚<br>ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„ã€‚</p>';
      showLoader(true);
      google.script.run.withSuccessHandler(showSuccess).withFailureHandler(showError).processShipment(sendData);
    }

    function showSuccess(res) {
      showLoader(false);
      if(res.status === 'error') { showError(res.message); return; }
      document.getElementById('main-content').style.display = 'none';
      const msg = document.getElementById('message-area');
      msg.style.display = 'block';
      msg.className = 'success';
      msg.innerHTML = `
        <strong>å‡ºè·å‡¦ç†ãŒå®Œäº†ã—ã¾ã—ãŸã€‚</strong><br>
        ã€Œå‡ºè·æ¸ˆæ˜ç´°ã€ã‚·ãƒ¼ãƒˆã«è¨˜éŒ²ã—ã€ã€Œå‡ºè·æ¸ˆæ•°ã€ã‚’æ›´æ–°ã—ã¾ã—ãŸã€‚<br>
        æ–°ã—ã„ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆï¼ˆ${res.newSheetName}ï¼‰ãŒä½œæˆã•ã‚Œã¾ã—ãŸã€‚<br><br>
        <a href="${res.newSheetUrl}" target="_blank" style="display:block; margin:10px 0; padding:10px; background:#28a745; color:white; text-align:center; text-decoration:none; border-radius:5px;">ä½œæˆã—ãŸä¼ç¥¨ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é–‹ã</a>
        <button class="button button-secondary" onclick="runDataFetch()">ç¶šã‘ã¦åˆ¥ã®å‡ºè·å‡¦ç†ã‚’è¡Œã†ï¼ˆç”»é¢ã‚’æ›´æ–°ï¼‰</button>
      `;
    }

    function showLoader(visible, text) {
      const l = document.getElementById('loader');
      l.style.display = visible ? 'block' : 'none';
      if(text) l.querySelector('p').innerHTML = text;
    }
    function showError(msg) { showLoader(false); alert('ã‚¨ãƒ©ãƒ¼: ' + msg); }
  </script>
</body>
</html>
